<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åº“å­˜ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif; background: #fff; min-height: 100vh; padding: 15px; }
        #app { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: #2c3e50; margin-bottom: 25px; }
        .header h1 { font-size: 2em; margin-bottom: 8px; font-weight: 600; }
        .header p { font-size: 0.95em; color: #7f8c8d; }
        .container { background: white; border-radius: 12px; border: 1px solid #e8e8e8; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
        .tabs { display: flex; background: #fafafa; border-bottom: 1px solid #e8e8e8; }
        .tab { flex: 1; padding: 16px 20px; text-align: center; cursor: pointer; font-size: 15px; font-weight: 500; color: #666; transition: all 0.2s; }
        .tab:hover { background: #f5f5f5; color: #333; }
        .tab.active { background: white; color: #1890ff; border-bottom: 2px solid #1890ff; }
        .tab-content { padding: 20px; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #333; border-left: 3px solid #1890ff; padding-left: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #f0f0f0; }
        thead { background: #f5f5f5; color: #333; }
        th { padding: 12px 10px; text-align: center; font-weight: 600; font-size: 13px; border-bottom: 1px solid #e8e8e8; }
        td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        tbody tr:hover { background: #fafafa; }
       .stock-init { color: #52c41a; font-weight: 600; }
        .stock-remain { color: #1890ff; font-weight: 500; }
        .stock-deficit { color: #ff4d4f; font-weight: 600; }
        .empty-cell { color: #d9d9d9; }
        .form-group { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: flex-end; }
        .form-item { flex: 1; min-width: 150px; }
        .form-item label { display: block; margin-bottom: 8px; color: #606266; font-weight: 500; font-size: 14px; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px 12px; border: 1px solid #dcdfe6; border-radius: 6px; font-size: 14px; transition: all 0.3s; }
        input:focus, select:focus { outline: none; border-color: #1890ff; }
        button { padding: 10px 24px; background: #1890ff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        button:hover { background: #40a9ff; }
        .btn-secondary { background: #52c41a; }
        .btn-secondary:hover { background: #73d13d; }
        .btn-danger { background: #ff4d4f; }
        .btn-danger:hover { background: #ff7875; }
        .stock-input { width: 70px; padding: 6px; text-align: center; border: 1px solid #dcdfe6; border-radius: 4px; }
        .loading { text-align: center; padding: 40px; color: #909399; }
        .alert { padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; animation: fadeIn 0.3s; }
        .alert-success { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
        .alert-error { background: #fff2f0; color: #ff4d4f; border: 1px solid #ffccc7; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .item-type-switch { display: flex; gap: 15px; margin-bottom: 15px; }
        .type-option { padding: 8px 20px; border: 1px solid #d9d9d9; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .type-option:hover { border-color: #1890ff; }
        .type-option.active { background: #1890ff; color: white; border-color: #1890ff; }
        .section-block { margin-top: 30px; padding: 20px; background: #fafafa; border-radius: 8px; border: 1px solid #e8e8e8; }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header h1 { font-size: 1.5em; }
            .tab-content { padding: 15px; }
            .form-group { flex-direction: column; gap: 12px; }
            .form-item { width: 100%; min-width: auto; }
            .tabs { overflow-x: auto; }
            .tab { padding: 12px 16px; font-size: 14px; white-space: nowrap; }
            table { font-size: 12px; }
            th, td { padding: 8px 6px; }
        }
        @media (max-width: 480px) {
            .header h1 { font-size: 1.3em; }
            th, td { padding: 6px 4px; font-size: 11px; }
            button { padding: 8px 16px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>ğŸ‘” åº“å­˜ç®¡ç†ç³»ç»Ÿ</h1>
            <p>è½»é‡çº§åº“å­˜ç®¡ç†ä¸ä½¿ç”¨è®°å½•è¿½è¸ª</p>
        </div>

        <div class="container">
            <div class="tabs">
                <div class="tab" :class="{active: activeTab === 'dashboard'}" @click="activeTab = 'dashboard'">ğŸ“Š å‰©ä½™æ€»è¡¨</div>
                <div class="tab" :class="{active: activeTab === 'usage'}" @click="activeTab = 'usage'">ğŸ“ ä½¿ç”¨è®°å½•</div>
                <div class="tab" :class="{active: activeTab === 'stock'}" @click="activeTab = 'stock'">ğŸ“¦ åº“å­˜è®¾ç½®</div>
            </div>

            <div class="tab-content">
                <div v-if="alert.show" :class="['alert', alert.type === 'success' ? 'alert-success' : 'alert-error']">{{ alert.message }}</div>

                <!-- Tab 1: å‰©ä½™æ€»è¡¨ -->
                <div v-show="activeTab === 'dashboard'">
                    <h2 class="section-title">è¡£æœåº“å­˜</h2>
                    <div v-if="loading" class="loading">åŠ è½½ä¸­...</div>
                    <table v-else>
                        <thead>
                            <tr>
                                <th>æ¬¾å¼/å°ºå¯¸</th>
                                <th v-for="size in dashboardData.clothing?.sizes" :key="size">{{ size }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="style in dashboardData.clothing?.styles" :key="style">
                                <td><strong>{{ style }}</strong></td>
                                <td v-for="size in dashboardData.clothing?.sizes" :key="size">
                                    <span v-if="dashboardData.clothing.matrix[style] && dashboardData.clothing.matrix[style][size]">
                                        <span class="stock-init">{{ dashboardData.clothing.matrix[style][size].init }}</span>
                                        <span> / </span>
                                        <span :class="dashboardData.clothing.matrix[style][size].remain < 0 ? 'stock-deficit' : 'stock-remain'">
                                            {{ dashboardData.clothing.matrix[style][size].remain >= 0 ? 'ä½™' : 'æ¬ ' }}{{ Math.abs(dashboardData.clothing.matrix[style][size].remain) }}
                                        </span>
                                    </span>
                                    <span v-else class="empty-cell">-</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="section-block">
                        <h2 class="section-title">å…¶å®ƒç‰©å“</h2>
                        <div v-if="!dashboardData.otherItems || dashboardData.otherItems.length === 0" class="loading">æš‚æ— å…¶å®ƒç‰©å“</div>
                        <table v-else>
                            <thead>
                                <tr>
                                    <th>ç‰©å“åç§°</th>
                                    <th>æ•°é‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in dashboardData.otherItems" :key="item.id">
                                    <td><strong>{{ item.name }}</strong></td>
                                    <td>
                                        <span class="stock-init">{{ item.init }}</span>
                                        <span> / </span>
                                        <span :class="item.remain < 0 ? 'stock-deficit' : 'stock-remain'">
                                            {{ item.remain >= 0 ? 'ä½™' : 'æ¬ ' }}{{ Math.abs(item.remain) }}
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab 2: ä½¿ç”¨è®°å½• -->
                <div v-show="activeTab === 'usage'">
                    <h2 class="section-title">æ·»åŠ ä½¿ç”¨è®°å½•</h2>
                    <div class="item-type-switch">
                        <div class="type-option" :class="{active: usageForm.itemType === 'clothing'}" @click="usageForm.itemType = 'clothing'">è¡£æœ</div>
                        <div class="type-option" :class="{active: usageForm.itemType === 'other'}" @click="usageForm.itemType = 'other'">å…¶å®ƒç‰©å“</div>
                    </div>
                    <div class="form-group">
                        <div class="form-item">
                            <label>å§“å</label>
                            <input type="text" v-model="usageForm.user" placeholder="è¯·è¾“å…¥å§“å">
                        </div>
                        <template v-if="usageForm.itemType === 'clothing'">
                            <div class="form-item">
                                <label>æ¬¾å¼</label>
                                <select v-model="usageForm.style">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option v-for="style in stylesList" :key="style" :value="style">{{ style }}</option>
                                </select>
                            </div>
                            <div class="form-item">
                                <label>å°ºå¯¸</label>
                                <select v-model="usageForm.size">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option v-for="size in sizesList" :key="size" :value="size">{{ size }}</option>
                                </select>
                            </div>
                        </template>
                        <template v-else>
                            <div class="form-item">
                                <label>ç‰©å“åç§°</label>
                                <select v-model="usageForm.otherItemName">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option v-for="item in otherItemsList" :key="item.id" :value="item.name">{{ item.name }}</option>
                                </select>
                            </div>
                        </template>
                        <div class="form-item">
                            <label>æ•°é‡</label>
                            <input type="number" v-model="usageForm.qty" min="1" value="1">
                        </div>
                        <div class="form-item">
                            <label>å¤‡æ³¨</label>
                            <input type="text" v-model="usageForm.remark" placeholder="å¯é€‰">
                        </div>
                        <div class="form-item">
                            <label>&nbsp;</label>
                            <button @click="addUsageLog">â• æ·»åŠ </button>
                        </div>
                    </div>

                    <h2 class="section-title">ä½¿ç”¨æµæ°´</h2>
                    <div style="margin-bottom:15px;">
                        <button @click="exportUsageLogs" class="btn-secondary" style="margin-right:10px;">ğŸ“„ å¯¼å‡ºè®°å½•</button>
                        <button @click="$refs.importFile.click()" style="margin-right:10px;">ğŸ“‚ å¯¼å…¥è®°å½•</button>
                        <input ref="importFile" type="file" accept=".csv" @change="importUsageLogs" style="display:none;">
                        <span v-if="importStatus" :style="{color: importStatus.type === 'success' ? '#52c41a' : '#ff4d4f', marginLeft: '10px'}">
                            {{ importStatus.message }}
                        </span>
                    </div>
                    <div v-if="usageLogs.length === 0" class="loading">æš‚æ— è®°å½•</div>
                    <table v-else>
                        <thead>
                            <tr>
                                <th>å§“å</th>
                                <th>ç‰©å“ç±»å‹</th>
                                <th>æ¬¾å¼</th>
                                <th>å°ºå¯¸</th>
                                <th>æ•°é‡</th>
                                <th>å¤‡æ³¨</th>
                                <th>æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="log in usageLogs" :key="log.id">
                                <td>{{ log.user_name }}</td>
                                <td>{{ log.item_type === 'clothing' ? 'è¡£æœ' : log.other_item_name }}</td>
                                <td>{{ log.style_name || '-' }}</td>
                                <td>{{ log.size_name || '-' }}</td>
                                <td>{{ log.quantity }}</td>
                                <td>{{ log.remark || '-' }}</td>
                                <td style="color:#999; font-size:12px;">{{ log.created_at }}</td>
                                <td>
                                    <button @click="deleteUsageLog(log.id)" class="btn-danger" style="font-size:12px; padding:4px 10px;">åˆ é™¤</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Tab 3: åº“å­˜è®¾ç½® -->
                <div v-show="activeTab === 'stock'">
                    <h2 class="section-title">è¡£æœåˆå§‹åº“å­˜</h2>
                    <div style="margin-bottom:20px;">
                        <button @click="editMode = !editMode" class="btn-secondary">{{ editMode ? 'ğŸ”’ é”å®š' : 'âœï¸ ç¼–è¾‘' }}</button>
                        <button v-if="editMode" @click="saveAllStock" style="margin-left:10px;">ğŸ’¾ ä¿å­˜</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>æ¬¾å¼/å°ºå¯¸</th>
                                <th v-for="size in stockData.sizes" :key="size">{{ size }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="style in stockData.styles" :key="style">
                                <td><strong>{{ style }}</strong></td>
                                <td v-for="size in stockData.sizes" :key="size">
                                    <input v-if="editMode" type="number" class="stock-input" v-model.number="getStockValue(style, size)" @change="updateStock(style, size, $event)" min="0">
                                    <span v-else>{{ stockData.matrix[style] && stockData.matrix[style][size] ? stockData.matrix[style][size] : 0 }}</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="section-block">
                        <h2 class="section-title">å…¶å®ƒç‰©å“ç®¡ç†</h2>
                        <div style="margin-bottom:15px;">
                            <button @click="showAddOtherItemForm = !showAddOtherItemForm">{{ showAddOtherItemForm ? 'å–æ¶ˆ' : 'â• æ·»åŠ ç‰©å“' }}</button>
                        </div>
                        <div v-if="showAddOtherItemForm" class="form-group" style="margin-bottom:20px;">
                            <div class="form-item">
                                <label>ç‰©å“åç§°</label>
                                <input type="text" v-model="newOtherItem.name" placeholder="è¯·è¾“å…¥ç‰©å“åç§°">
                            </div>
                            <div class="form-item">
                                <label>åˆå§‹æ•°é‡</label>
                                <input type="number" v-model="newOtherItem.quantity" min="0" value="0">
                            </div>
                            <div class="form-item">
                                <label>&nbsp;</label>
                                <button @click="addOtherItem">ä¿å­˜ç‰©å“</button>
                            </div>
                        </div>
                        <div v-if="otherItemsList.length === 0" class="loading">æš‚æ— å…¶å®ƒç‰©å“</div>
                        <table v-else>
                            <thead>
                                <tr>
                                    <th>ç‰©å“åç§°</th>
                                    <th>åˆå§‹æ•°é‡</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in otherItemsList" :key="item.id">
                                    <td><strong>{{ item.name }}</strong></td>
                                    <td>
                                        <input v-if="editingOtherItemId === item.id" type="number" v-model.number="editingOtherItemQty" class="stock-input" min="0">
                                        <span v-else>{{ item.initial_quantity }}</span>
                                    </td>
                                    <td>
                                        <template v-if="editingOtherItemId === item.id">
                                            <button @click="saveOtherItemQty(item.id)" style="font-size:12px;">ä¿å­˜</button>
                                            <button @click="editingOtherItemId = null" style="font-size:12px; margin-left:5px;">å–æ¶ˆ</button>
                                        </template>
                                        <template v-else>
                                            <button @click="startEditOtherItem(item)" style="font-size:12px;">ç¼–è¾‘</button>
                                            <button @click="deleteOtherItem(item.id)" class="btn-danger" style="font-size:12px; margin-left:5px;">åˆ é™¤</button>
                                        </template>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    activeTab: 'dashboard',
                    loading: false,
                    editMode: false,
                    alert: { show: false, type: 'success', message: '' },
                    dashboardData: { clothing: { matrix: {}, styles: [], sizes: [] }, otherItems: [] },
                    stockData: { matrix: {}, styles: [], sizes: [] },
                    stylesList: [],
                    sizesList: [],
                    otherItemsList: [],
                    usageForm: { user: '', itemType: 'clothing', style: '', size: '', otherItemName: '', qty: 1, remark: '' },
                    usageLogs: [],
                    stockChanges: {},
                    showAddOtherItemForm: false,
                    newOtherItem: { name: '', quantity: 0 },
                    editingOtherItemId: null,
                    editingOtherItemQty: 0,
                    importStatus: null
                };
            },
            mounted() {
                this.init();
            },
            methods: {
                async init() {
                    await this.loadStyles();
                    await this.loadSizes();
                    await this.loadOtherItems();
                    await this.loadDashboard();
                    await this.loadStockInit();
                    await this.loadUsageLogs();
                },
                async loadStyles() {
                    try {
                        const res = await fetch('/api/styles');
                        const data = await res.json();
                        if (data.success) this.stylesList = data.styles.map(s => s.name);
                    } catch (error) {
                        console.error('åŠ è½½æ¬¾å¼å¤±è´¥:', error);
                    }
                },
                async loadSizes() {
                    try {
                        const res = await fetch('/api/sizes');
                        const data = await res.json();
                        if (data.success) this.sizesList = data.sizes.map(s => s.name);
                    } catch (error) {
                        console.error('åŠ è½½å°ºå¯¸å¤±è´¥:', error);
                    }
                },
                async loadOtherItems() {
                    try {
                        const res = await fetch('/api/other-items');
                        const data = await res.json();
                        if (data.success) this.otherItemsList = data.items;
                    } catch (error) {
                        console.error('åŠ è½½å…¶å®ƒç‰©å“å¤±è´¥:', error);
                    }
                },
                async loadDashboard() {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/stock/dashboard');
                        const data = await res.json();
                        if (data.success) this.dashboardData = data;
                    } catch (error) {
                        console.error('åŠ è½½å¤±è´¥:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                async loadStockInit() {
                    try {
                        const res = await fetch('/api/stock/init');
                        const data = await res.json();
                        if (data.success) this.stockData = data;
                    } catch (error) {
                        console.error('åŠ è½½å¤±è´¥:', error);
                    }
                },
                async loadUsageLogs() {
                    try {
                        const res = await fetch('/api/usage/logs');
                        const data = await res.json();
                        if (data.success) this.usageLogs = data.logs;
                    } catch (error) {
                        console.error('åŠ è½½å¤±è´¥:', error);
                    }
                },
                async addUsageLog() {
                    if (!this.usageForm.user) {
                        this.showAlert('error', 'è¯·è¾“å…¥å§“åï¼');
                        return;
                    }

                    if (this.usageForm.itemType === 'clothing' && (!this.usageForm.style || !this.usageForm.size)) {
                        this.showAlert('error', 'è¯·é€‰æ‹©æ¬¾å¼å’Œå°ºå¯¸ï¼');
                        return;
                    }

                    if (this.usageForm.itemType === 'other' && !this.usageForm.otherItemName) {
                        this.showAlert('error', 'è¯·é€‰æ‹©ç‰©å“ï¼');
                        return;
                    }

                    try {
                        const res = await fetch('/api/usage/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user: this.usageForm.user,
                                itemType: this.usageForm.itemType,
                                style: this.usageForm.style,
                                size: this.usageForm.size,
                                otherItemName: this.usageForm.otherItemName,
                                qty: this.usageForm.qty,
                                remark: this.usageForm.remark
                            })
                        });
                        const data = await res.json();

                        if (data.success) {
                            this.showAlert('success', 'å·²æ·»åŠ ï¼');
                            this.usageForm = { user: '', itemType: 'clothing', style: '', size: '', otherItemName: '', qty: 1, remark: '' };
                            await this.loadUsageLogs();
                            await this.loadDashboard();
                        } else {
                            this.showAlert('error', 'æ·»åŠ å¤±è´¥ï¼š' + data.error);
                        }
                    } catch (error) {
                        this.showAlert('error', 'æ·»åŠ å¤±è´¥ï¼š' + error.message);
                    }
                },
                async addOtherItem() {
                    if (!this.newOtherItem.name) {
                        this.showAlert('error', 'è¯·è¾“å…¥ç‰©å“åç§°ï¼');
                        return;
                    }

                    try {
                        const res = await fetch('/api/other-items', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.newOtherItem.name,
                                quantity: this.newOtherItem.quantity
                            })
                        });
                        const data = await res.json();

                        if (data.success) {
                            this.showAlert('success', 'ç‰©å“å·²æ·»åŠ ï¼');
                            this.newOtherItem = { name: '', quantity: 0 };
                            this.showAddOtherItemForm = false;
                            await this.loadOtherItems();
                            await this.loadDashboard();
                        } else {
                            this.showAlert('error', 'æ·»åŠ å¤±è´¥ï¼š' + data.error);
                        }
                    } catch (error) {
                        this.showAlert('error', 'æ·»åŠ å¤±è´¥ï¼š' + error.message);
                    }
                },
                startEditOtherItem(item) {
                    this.editingOtherItemId = item.id;
                    this.editingOtherItemQty = item.initial_quantity;
                },
                async saveOtherItemQty(itemId) {
                    try {
                        const res = await fetch(`/api/other-items/${itemId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ quantity: this.editingOtherItemQty })
                        });
                        const data = await res.json();

                        if (data.success) {
                            this.showAlert('success', 'åº“å­˜å·²æ›´æ–°ï¼');
                            this.editingOtherItemId = null;
                            await this.loadOtherItems();
                            await this.loadDashboard();
                        } else {
                            this.showAlert('error', 'æ›´æ–°å¤±è´¥ï¼š' + data.error);
                        }
                    } catch (error) {
                        this.showAlert('error', 'æ›´æ–°å¤±è´¥ï¼š' + error.message);
                    }
                },
                async deleteOtherItem(itemId) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç‰©å“å—ï¼Ÿ')) return;

                    try {
                        const res = await fetch(`/api/other-items/${itemId}`, { method: 'DELETE' });
                        const data = await res.json();

                        if (data.success) {
                            this.showAlert('success', 'ç‰©å“å·²åˆ é™¤ï¼');
                            await this.loadOtherItems();
                            await this.loadDashboard();
                        } else {
                            this.showAlert('error', 'åˆ é™¤å¤±è´¥ï¼š' + data.error);
                        }
                    } catch (error) {
                        this.showAlert('error', 'åˆ é™¤å¤±è´¥ï¼š' + error.message);
                    }
                },
                getStockValue(style, size) {
                    if (!this.stockData.matrix[style]) {
                        this.stockData.matrix[style] = {};
                    }
                    return this.stockData.matrix[style][size] || 0;
                },
                updateStock(style, size, event) {
                    const value = parseInt(event.target.value) || 0;
                    if (!this.stockData.matrix[style]) {
                        this.stockData.matrix[style] = {};
                    }
                    this.stockData.matrix[style][size] = value;
                    const key = `${style}_${size}`;
                    this.stockChanges[key] = { style, size, qty: value };
                },
                async saveAllStock() {
                    const changes = Object.values(this.stockChanges);
                    if (changes.length === 0) {
                        this.showAlert('error', 'æ²¡æœ‰ä¿®æ”¹');
                        return;
                    }

                    try {
                        for (const change of changes) {
                            await fetch('/api/stock/init', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(change)
                            });
                        }

                        this.showAlert('success', `å·²ä¿å­˜ ${changes.length} é¡¹ï¼`);
                        this.stockChanges = {};
                        this.editMode = false;
                        await this.loadStockInit();
                        await this.loadDashboard();
                    } catch (error) {
                        this.showAlert('error', 'ä¿å­˜å¤±è´¥ï¼š' + error.message);
                    }
                },
                async deleteUsageLog(logId) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ä½¿ç”¨è®°å½•å—ï¼Ÿ')) return;

                    try {
                        const res = await fetch(`/api/usage/logs/${logId}`, { method: 'DELETE' });
                        const data = await res.json();

                        if (data.success) {
                            this.showAlert('success', 'ä½¿ç”¨è®°å½•å·²åˆ é™¤ï¼');
                            await this.loadUsageLogs();
                            await this.loadDashboard();  // å®æ—¶æ›´æ–°å‰©ä½™æ€»è¡¨
                        } else {
                            this.showAlert('error', 'åˆ é™¤å¤±è´¥ï¼š' + data.error);
                        }
                    } catch (error) {
                        this.showAlert('error', 'åˆ é™¤å¤±è´¥ï¼š' + error.message);
                    }
                },
                exportUsageLogs() {
                    if (this.usageLogs.length === 0) {
                        this.showAlert('error', 'æ²¡æœ‰è®°å½•å¯å¯¼å‡º');
                        return;
                    }

                    // CSV å¤´éƒ¨
                    const headers = ['å§“å', 'ç‰©å“ç±»å‹', 'æ¬¾å¼', 'å°ºå¯¸', 'ç‰©å“åç§°', 'æ•°é‡', 'å¤‡æ³¨', 'æ—¶é—´'];
                    let csv = headers.join(',') + '\n';

                    // æ•°æ®è¡Œ
                    this.usageLogs.forEach(log => {
                        const row = [
                            log.user_name,
                            log.item_type === 'clothing' ? 'è¡£æœ' : 'å…¶å®ƒ',
                            log.style_name || '',
                            log.size_name || '',
                            log.other_item_name || '',
                            log.quantity,
                            log.remark || '',
                            log.created_at
                        ];
                        csv += row.map(cell => `"${cell}"`).join(',') + '\n';
                    });


                    // ä¸‹è½½æ–‡ä»¶ï¼ˆä½¿ç”¨ UTF-16 LE ç¼–ç ï¼ŒExcel å…¼å®¹æ€§æ›´å¥½ï¼‰
                    const bom = new Uint8Array([0xFF, 0xFE]); // UTF-16 LE BOM
                    
                    // è½¬æ¢ä¸º UTF-16 LE
                    let utf16 = '';
                    for (let i = 0; i < csv.length; i++) {
                        const code = csv.charCodeAt(i);
                        utf16 += String.fromCharCode(code & 0xFF, (code >> 8) & 0xFF);
                    }
                    
                    const blob = new Blob([bom, utf16], { type: 'text/csv;charset=UTF-16LE;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `ä½¿ç”¨è®°å½•_${new Date().toISOString().slice(0,10)}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    this.showAlert('success', `å·²å¯¼å‡º ${this.usageLogs.length} æ¡è®°å½•`);
                },
                async importUsageLogs(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    this.importStatus = { type: 'info', message: 'æ­£åœ¨å¯¼å…¥...' };

                    try {
                        const text = await file.text();
                        const lines = text.split('\n').filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            this.importStatus = { type: 'error', message: 'CSV æ–‡ä»¶ä¸ºç©º' };
                            return;
                        }

                        // è·³è¿‡å¤´éƒ¨
                        const dataLines = lines.slice(1);
                        let successCount = 0;
                        let errorCount = 0;

                        for (const line of dataLines) {
                            // è§£æ CSV è¡Œï¼ˆå¤„ç†å¼•å·ï¼‰
                            const matches = line.match(/"([^"]*)"|([^,]+)/g);
                            if (!matches || matches.length < 6) continue;

                            const values = matches.map(v => v.replace(/^"|"$/g, '').trim());
                            const [userName, itemTypeText, style, size, otherItemName, quantity, remark] = values;

                            if (!userName || !quantity) {
                                errorCount++;
                                continue;
                            }

                            const itemType = itemTypeText === 'è¡£æœ' ? 'clothing' : 'other';
                            
                            try {
                                const res = await fetch('/api/usage/add', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        user: userName,
                                        itemType: itemType,
                                        style: style || undefined,
                                        size: size || undefined,
                                        otherItemName: otherItemName || undefined,
                                        qty: parseInt(quantity) || 1,
                                        remark: remark || undefined
                                    })
                                });
                                const data = await res.json();
                                if (data.success) {
                                    successCount++;
                                } else {
                                    errorCount++;
                                }
                            } catch (error) {
                                errorCount++;
                            }
                        }

                        this.importStatus = { 
                            type: errorCount === 0 ? 'success' : 'error', 
                            message: `å¯¼å…¥å®Œæˆï¼šæˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${errorCount} æ¡` 
                        };

                        // åˆ·æ–°æ•°æ®
                        await this.loadUsageLogs();
                        await this.loadDashboard();

                        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                        event.target.value = '';

                        // 3ç§’åæ¸…é™¤çŠ¶æ€
                        setTimeout(() => { this.importStatus = null; }, 3000);
                    } catch (error) {
                        this.importStatus = { type: 'error', message: 'å¯¼å…¥å¤±è´¥ï¼š' + error.message };
                    }
                },
                showAlert(type, message) {
                    this.alert = { show: true, type, message };
                    setTimeout(() => { this.alert.show = false; }, 3000);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
